{% extends "base.html.j2" %}

{% block title %}建物一覧 | tatemono-map{% endblock %}

{% block header_meta %}
  <small class="muted">公開向け物件サマリー</small>
{% endblock %}

{% block extra_head %}
<style>
  .hero {
    padding: 22px;
    margin-bottom: 16px;
  }

  .hero h1 {
    margin: 0;
    font-size: clamp(1.25rem, 2.8vw, 1.9rem);
    line-height: 1.3;
  }

  .hero p {
    margin: 8px 0 0;
    color: var(--muted);
    font-size: .98rem;
  }

  .controls {
    display: grid;
    grid-template-columns: minmax(0, 1fr) 210px;
    gap: 10px;
    margin-bottom: 14px;
  }

  .field {
    display: grid;
    gap: 6px;
  }

  .field label {
    font-size: .84rem;
    color: var(--muted);
    font-weight: 700;
  }

  .field input,
  .field select {
    appearance: none;
    width: 100%;
    border: 1px solid var(--border);
    border-radius: 10px;
    padding: 10px 12px;
    font-size: 1rem;
    background: var(--surface);
    color: var(--text);
  }

  .field input:focus,
  .field select:focus {
    outline: 2px solid #bfdbfe;
    border-color: #93c5fd;
  }

  #building-list {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
    gap: 12px;
    margin: 0;
    padding: 0;
    list-style: none;
  }

  .building-card {
    display: flex;
    flex-direction: column;
    gap: 12px;
    padding: 14px;
  }

  .building-card h2 {
    margin: 0;
    font-size: 1.06rem;
    line-height: 1.4;
  }

  .building-link {
    text-decoration: none;
  }

  .building-link:hover h2 {
    text-decoration: underline;
    text-decoration-thickness: 2px;
    text-underline-offset: 2px;
  }

  .address {
    margin: 0;
    color: var(--muted);
    min-height: 2.8em;
  }

  .meta {
    display: grid;
    gap: 8px;
    margin-top: auto;
    font-size: .92rem;
    color: #0f172a;
  }

  .meta-row {
    display: flex;
    justify-content: space-between;
    gap: 10px;
    border-top: 1px dashed var(--border);
    padding-top: 8px;
  }

  .meta-row dt { color: var(--muted); }
  .meta-row dd { margin: 0; font-weight: 700; }

  .empty {
    margin: 24px 0 0;
    text-align: center;
    padding: 24px;
  }

  .empty[hidden] { display: none; }

  @media (max-width: 740px) {
    .hero { padding: 16px; }
    .controls { grid-template-columns: 1fr; }
    #building-list { grid-template-columns: 1fr; }
    .address { min-height: 0; }
  }
</style>
{% endblock %}

{% block content %}
  <section class="hero card" aria-label="建物一覧の案内">
    <h1>建物一覧</h1>
    <p>建物名や住所で検索し、更新日・空室数・家賃レンジで並び替えて比較できます。</p>
    <ul class="kpis" aria-label="一覧サマリー">
      <li class="kpi"><span>表示中</span><strong id="building-count">{{ buildings|length }}</strong>件</li>
      <li class="kpi"><span>全件数</span><strong id="building-total">{{ buildings|length }}</strong>件</li>
    </ul>
  </section>

  <section class="controls" aria-label="検索と並び替え">
    <div class="field">
      <label for="search">建物名・住所で絞り込み</label>
      <input id="search" type="search" placeholder="例: 渋谷 / レジデンス" autocomplete="off" />
    </div>
    <div class="field">
      <label for="sort">並び替え</label>
      <select id="sort">
        <option value="updated_desc">更新日時（新しい順）</option>
        <option value="vacancy_desc">空室数（多い順）</option>
        <option value="rent_min_asc">家賃下限（安い順）</option>
        <option value="rent_min_desc">家賃下限（高い順）</option>
      </select>
    </div>
  </section>

  <ul id="building-list" aria-live="polite">
    {% for b in buildings %}
      <li
        class="card building-card"
        data-name="{{ (b.name or '')|lower }}"
        data-address="{{ (b.address or '')|lower }}"
        data-updated="{{ b.updated_at or '' }}"
        data-vacancy="{{ b.vacancy_count if b.vacancy_count is not none else -1 }}"
        data-rent-min="{{ b.rent_yen_min if b.rent_yen_min is not none else 999999999 }}"
      >
        <a class="building-link" href="b/{{ b.building_key }}.html">
          <h2>{{ b.name or "名称未設定" }}</h2>
        </a>
        <p class="address">{{ b.address or "住所情報なし" }}</p>
        <ul class="kpis" aria-label="建物の主要情報">
          <li class="kpi"><span>空室</span>{{ b.vacancy_count if b.vacancy_count is not none else "—" }}件</li>
          <li class="kpi"><span>家賃</span>{{ b.rent_yen_min|yen }}円 〜 {{ b.rent_yen_max|yen }}円</li>
        </ul>
        <dl class="meta">
          <div class="meta-row">
            <dt>面積レンジ</dt>
            <dd>{{ (b.area_sqm_min ~ '㎡') if b.area_sqm_min is not none else '—' }} 〜 {{ (b.area_sqm_max ~ '㎡') if b.area_sqm_max is not none else '—' }}</dd>
          </div>
          <div class="meta-row">
            <dt>最終更新</dt>
            <dd>{{ b.last_updated or '—' }}</dd>
          </div>
        </dl>
      </li>
    {% endfor %}
  </ul>

  <div id="empty-state" class="card empty" hidden>
    条件に合う建物が見つかりませんでした。検索語を短くするか、並び替えを変えてお試しください。
  </div>
{% endblock %}

{% block extra_body %}
<script>
(() => {
  const input = document.getElementById('search');
  const sortSelect = document.getElementById('sort');
  const list = document.getElementById('building-list');
  const cards = Array.from(list.querySelectorAll('.building-card'));
  const count = document.getElementById('building-count');
  const total = document.getElementById('building-total');
  const empty = document.getElementById('empty-state');

  const byNumeric = (key, direction = 'asc') => (a, b) => {
    const av = Number(a.dataset[key]);
    const bv = Number(b.dataset[key]);
    if (av === bv) return 0;
    return direction === 'asc' ? av - bv : bv - av;
  };

  const byText = (key, direction = 'asc') => (a, b) => {
    const av = a.dataset[key] || '';
    const bv = b.dataset[key] || '';
    return direction === 'asc' ? av.localeCompare(bv, 'ja') : bv.localeCompare(av, 'ja');
  };

  const sorters = {
    updated_desc: byText('updated', 'desc'),
    vacancy_desc: byNumeric('vacancy', 'desc'),
    rent_min_asc: byNumeric('rentMin', 'asc'),
    rent_min_desc: byNumeric('rentMin', 'desc')
  };

  function update() {
    const q = input.value.trim().toLowerCase();
    const sorter = sorters[sortSelect.value] || sorters.updated_desc;

    const visible = [];
    for (const card of cards) {
      const haystack = `${card.dataset.name} ${card.dataset.address}`;
      const show = q === '' || haystack.includes(q);
      card.hidden = !show;
      if (show) visible.push(card);
    }

    visible.sort(sorter);
    for (const card of visible) {
      list.appendChild(card);
    }

    count.textContent = String(visible.length);
    total.textContent = String(cards.length);
    empty.hidden = visible.length !== 0;
  }

  input.addEventListener('input', update);
  sortSelect.addEventListener('change', update);
  update();
})();
</script>
{% endblock %}
