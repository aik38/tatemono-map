{% extends "base.html.j2" %}

{% block title %}建物一覧 | tatemono-map{% endblock %}

{% block header_meta %}{% endblock %}

{% block extra_head %}
<style>
  .intro { padding: 26px; margin-bottom: 18px; }
  .intro p { margin: 8px 0 0; color: var(--muted); }
  .intro-kpis { list-style: none; margin: 14px 0 0; padding: 0; display: flex; flex-wrap: wrap; gap: 8px; }
  .controls { display: grid; grid-template-columns: minmax(0, 1fr) 220px; gap: 12px; margin-bottom: 16px; }
  .counts { margin: -2px 0 14px; color: var(--muted); font-size: .92rem; white-space: nowrap; }
  .counts strong { color: var(--text); font-weight: 700; font-variant-numeric: tabular-nums; }
  .field { display: grid; gap: 6px; }
  .field label { font-size: .82rem; color: var(--muted); font-weight: 600; }
  .field input, .field select {
    width: 100%; border: 1px solid var(--border); background: #fff; border-radius: 10px;
    padding: 11px 12px; font-size: 1rem;
  }
  #building-list { list-style: none; margin: 0; padding: 0; display: grid; gap: 12px; }
  .building-card { padding: 18px; display: grid; gap: 10px; }
  .building-link { text-decoration: none; }
  .building-link:hover h2 { text-decoration: underline; text-underline-offset: 3px; }
  .address { margin: 0; color: var(--muted); }
  .meta { margin: 0; display: grid; gap: 7px; }
  .meta-row { margin: 0; display: grid; grid-template-columns: 120px minmax(0,1fr); }
  .meta-row dt { color: var(--muted); }
  .meta-row dd { margin: 0; font-weight: 600; }
  .kpis { list-style: none; margin: 0; padding: 0; display: flex; flex-wrap: wrap; gap: 8px; }
  .kpi { border-radius: 999px; background: #f2f4f8; padding: 5px 10px; font-size: .84rem; }
  .kpi span { color: var(--muted); margin-right: 6px; }
  #result-counts[hidden] { display: none; }
  .empty { margin-top: 20px; padding: 20px; text-align: center; }
  .empty[hidden] { display: none; }
  .actions { margin-top: 16px; display: flex; justify-content: center; }
  #load-more[hidden] { display: none; }
  .button-secondary {
    border: 1px solid var(--border); background: #fff; border-radius: 10px;
    padding: 10px 16px; font-size: .95rem; font-weight: 600; cursor: pointer;
  }
  @media (max-width: 740px) {
    .intro { padding: 18px; }
    .controls { grid-template-columns: 1fr; }
    .meta-row { grid-template-columns: 1fr; gap: 2px; }
  }
</style>
{% endblock %}

{% block content %}
  <section class="intro card" aria-label="建物一覧の案内">
    <h1>建物マップ</h1>
    <p>マンション・アパートや住所で検索して、データをまとめて確認できます。</p>
    <ul class="intro-kpis" aria-label="全体KPI">
      <li class="kpi"><span>建物数</span>{{ total_buildings_formatted }}件</li>
      <li class="kpi"><span>空部屋</span>{{ vacancy_total_formatted }}件</li>
    </ul>
  </section>

  <section class="controls" aria-label="検索と並び替え">
    <div class="field">
      <label for="search">建物名・住所で検索</label>
      <input id="search" type="search" placeholder="例：砂津 / 京町 / レジデンス" autocomplete="off" />
    </div>
    <div class="field">
      <label for="sort">並び替え</label>
      <select id="sort">
        <option value="updated_desc">更新日時（新しい順）</option>
        <option value="vacancy_desc">空室数（多い順）</option>
        <option value="rent_min_asc">家賃下限（安い順）</option>
        <option value="rent_min_desc">家賃下限（高い順）</option>
      </select>
    </div>
  </section>

  <p id="result-counts" class="counts" aria-live="polite" hidden>検索結果: <strong id="result-count-visible">{{ total_buildings_formatted }}件</strong><span id="result-count-total"></span> / 空室 <strong id="result-count-vacant">{{ vacancy_total_formatted }}件</strong></p>

  <ul id="building-list" aria-live="polite"></ul>

  <div id="empty-state" class="card empty" hidden>条件に合う建物が見つかりませんでした。</div>
  <div class="actions">
    <button id="load-more" class="button-secondary" type="button" hidden>もっと表示</button>
  </div>
{% endblock %}

{% block extra_body %}
<script>
(() => {
  const input = document.getElementById('search');
  const sortSelect = document.getElementById('sort');
  const list = document.getElementById('building-list');
  const visibleCount = document.getElementById('result-count-visible');
  const totalCount = document.getElementById('result-count-total');
  const vacantCount = document.getElementById('result-count-vacant');
  const counts = document.getElementById('result-counts');
  const empty = document.getElementById('empty-state');
  const loadMore = document.getElementById('load-more');

  const PAGE_SIZE = 50;
  const SEARCH_RENDER_LIMIT = 200;
  const SEARCH_DEBOUNCE_MS = 250;
  const formatCount = (n) => new Intl.NumberFormat('ja-JP').format(n);
  const normalizeText = (text) => (text || '').normalize('NFKC').toLowerCase().replace(/[\s　]+/g, ' ').trim();
  const safeNumber = (value, fallback) => Number.isFinite(Number(value)) ? Number(value) : fallback;
  const formatYen = (value) => Number.isFinite(Number(value)) ? `${formatCount(Number(value))}円` : '—';
  const formatArea = (value) => Number.isFinite(Number(value)) ? `${Number(value)}㎡` : '—';

  const byNumeric = (key, direction = 'asc') => (a, b) => direction === 'asc' ? a[key] - b[key] : b[key] - a[key];
  const byText = (key, direction = 'asc') => (a, b) => direction === 'asc' ? a[key].localeCompare(b[key], 'ja') : b[key].localeCompare(a[key], 'ja');
  const sorters = {
    updated_desc: byNumeric('updatedEpoch', 'desc'),
    vacancy_desc: byNumeric('vacancySort', 'desc'),
    rent_min_asc: byNumeric('rentMinSort', 'asc'),
    rent_min_desc: byNumeric('rentMinSort', 'desc')
  };

  let buildings = [];
  let filtered = [];
  let displayLimit = PAGE_SIZE;
  let currentQuery = '';
  let debounceTimer = null;

  function getMatchScore(card, q) {
    if (!q) return 0;
    let score = 0;
    let matched = false;
    if (card.nameNormalized.startsWith(q)) {
      score += 300;
      matched = true;
    } else if (card.nameNormalized.includes(q)) {
      score += 200;
      matched = true;
    }
    if (card.addressNormalized.startsWith(q)) {
      score += 120;
      matched = true;
    } else if (card.addressNormalized.includes(q)) {
      score += 80;
      matched = true;
    }
    if (card.combined.includes(q)) {
      score += 20;
      matched = true;
    }
    return matched ? score : 0;
  }

  function compareCards(a, b, q, sorter) {
    if (q !== '' && b.score !== a.score) {
      return b.score - a.score;
    }
    const sortResult = sorter(a, b);
    if (sortResult !== 0) {
      return sortResult;
    }
    return a.originalIndex - b.originalIndex;
  }

  function createCard(item) {
    const li = document.createElement('li');
    li.className = 'card building-card';

    const link = document.createElement('a');
    link.className = 'building-link';
    link.href = `b/${item.id}.html`;
    const h2 = document.createElement('h2');
    h2.textContent = item.name || '名称未設定';
    link.appendChild(h2);

    const address = document.createElement('p');
    address.className = 'address';
    address.textContent = item.address || '住所情報なし';

    const kpis = document.createElement('ul');
    kpis.className = 'kpis';
    const vacancyKpi = document.createElement('li');
    vacancyKpi.className = 'kpi';
    vacancyKpi.innerHTML = `<span>空室</span>${Number.isFinite(Number(item.vacancyCount)) ? Number(item.vacancyCount) : '—'}件`;
    const rentKpi = document.createElement('li');
    rentKpi.className = 'kpi';
    rentKpi.innerHTML = `<span>家賃</span>${formatYen(item.rentMin)}〜${formatYen(item.rentMax)}`;
    kpis.append(vacancyKpi, rentKpi);

    const meta = document.createElement('dl');
    meta.className = 'meta';
    const areaRow = document.createElement('div');
    areaRow.className = 'meta-row';
    areaRow.innerHTML = `<dt>面積</dt><dd>${formatArea(item.areaMin)} 〜 ${formatArea(item.areaMax)}</dd>`;
    const updatedRow = document.createElement('div');
    updatedRow.className = 'meta-row';
    updatedRow.innerHTML = `<dt>最終更新</dt><dd>${item.updatedAt || '—'}</dd>`;
    meta.append(areaRow, updatedRow);

    li.append(link, address, kpis, meta);
    return li;
  }

  function updateCounters(renderedCount, filteredCount) {
    const visibleVacancies = filtered.slice(0, renderedCount).reduce((sum, b) => sum + b.vacancyCountSafe, 0);
    const shouldShowCounts = currentQuery !== '';
    counts.hidden = !shouldShowCounts;

    visibleCount.textContent = `${formatCount(filteredCount)}件`;
    totalCount.textContent = shouldShowCounts ? `（全${formatCount(buildings.length)}件）` : '';
    vacantCount.textContent = `${formatCount(visibleVacancies)}件`;
  }

  function render() {
    const renderTargetCount = currentQuery ? Math.min(filtered.length, SEARCH_RENDER_LIMIT) : filtered.length;
    const renderedCount = Math.min(renderTargetCount, displayLimit);
    const fragment = document.createDocumentFragment();
    for (let i = 0; i < renderedCount; i += 1) {
      fragment.appendChild(createCard(filtered[i]));
    }

    list.replaceChildren(fragment);
    empty.hidden = filtered.length !== 0;
    updateCounters(renderedCount, filtered.length);

    const canMore = renderedCount < renderTargetCount;
    loadMore.hidden = !canMore;
  }

  function applyFiltersAndSort(resetLimit = false) {
    const sorter = sorters[sortSelect.value] || sorters.updated_desc;
    filtered = [];

    buildings.forEach((item) => {
      item.score = getMatchScore(item, currentQuery);
      if (currentQuery !== '' && item.score === 0) return;
      filtered.push(item);
    });

    filtered.sort((a, b) => compareCards(a, b, currentQuery, sorter));
    if (resetLimit) {
      displayLimit = PAGE_SIZE;
    }
    render();
  }

  function handleInput() {
    currentQuery = normalizeText(input.value);
    if (debounceTimer) {
      clearTimeout(debounceTimer);
    }
    debounceTimer = window.setTimeout(() => {
      applyFiltersAndSort(true);
    }, SEARCH_DEBOUNCE_MS);
  }

  function showError(message) {
    list.replaceChildren();
    empty.hidden = false;
    empty.textContent = message;
    loadMore.hidden = true;
    counts.hidden = true;
  }

  async function init() {
    try {
      const response = await fetch('./data/buildings.json', { cache: 'no-cache' });
      if (!response.ok) {
        throw new Error(`HTTP ${response.status}`);
      }
      const raw = await response.json();
      buildings = raw.map((item, index) => ({
        id: item.id,
        name: item.name || '',
        address: item.address || '',
        vacancyCount: safeNumber(item.vacancy_count, 0),
        vacancyCountSafe: Math.max(0, safeNumber(item.vacancy_count, 0)),
        rentMin: item.rent_min,
        rentMax: item.rent_max,
        areaMin: item.area_min,
        areaMax: item.area_max,
        updatedAt: item.updated_at || '',
        updatedEpoch: safeNumber(item.updated_epoch, -1),
        rentMinSort: Number.isFinite(Number(item.rent_min)) ? Number(item.rent_min) : 999999999,
        vacancySort: safeNumber(item.vacancy_count, -1),
        nameNormalized: normalizeText(item.name || ''),
        addressNormalized: normalizeText(item.address || ''),
        combined: normalizeText(`${item.name || ''} ${item.address || ''}`),
        originalIndex: index,
        score: 0
      }));

      const totalBuildings = buildings.length;
      const totalVacancies = buildings.reduce((sum, b) => sum + b.vacancyCountSafe, 0);
      document.querySelector('.intro-kpis .kpi:nth-child(1)').innerHTML = `<span>建物数</span>${formatCount(totalBuildings)}件`;
      document.querySelector('.intro-kpis .kpi:nth-child(2)').innerHTML = `<span>空部屋</span>${formatCount(totalVacancies)}件`;

      applyFiltersAndSort(true);
    } catch (error) {
      showError('データの読み込みに失敗しました。時間をおいて再読み込みしてください。');
    }
  }

  loadMore.addEventListener('click', () => {
    displayLimit += PAGE_SIZE;
    render();
  });
  input.addEventListener('input', handleInput);
  input.addEventListener('search', handleInput);
  input.addEventListener('change', handleInput);
  sortSelect.addEventListener('change', () => applyFiltersAndSort(true));

  init();
})();
</script>
{% endblock %}
